<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCBç”¢æ¥­ä¸Šå¸‚æ«ƒå…¬å¸ç‡Ÿæ”¶æŸ¥è©¢ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; color: #333; background-color: #ffffff; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; border: 1px solid #eaeaea; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border-radius: 8px;}
        h2 { text-align: center; color: #222; font-weight: 600; margin-bottom: 30px; }
        .controls { margin-bottom: 20px; padding: 20px; background: #f8f9fa; border: 1px solid #eeeeee; display: flex; gap: 20px; align-items: center; justify-content: center; border-radius: 6px; }
        .controls select { padding: 10px; border: 1px solid #ccc; font-size: 15px; border-radius: 4px; min-width: 150px; cursor: pointer; }
        .chart-container { position: relative; height: 450px; width: 100%; margin-bottom: 30px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #eaeaea; padding: 12px; text-align: center; }
        th { background-color: #f1f3f5; color: #333; position: sticky; top: 0; font-weight: 600; z-index: 10; }
        tr:hover { background-color: #f8f9fa; }
        button { padding: 10px 24px; background-color: #1971c2; color: white; border: none; cursor: pointer; font-weight: bold; font-size: 15px; border-radius: 4px; transition: 0.2s; }
        button:hover { background-color: #1864ab; }
        .data-table-container { max-height: 500px; overflow-y: auto; border: 1px solid #eaeaea; border-radius: 4px; }
        .loading { text-align: center; color: #e67e22; font-weight: bold; font-size: 1.1em; margin: 20px 0; }
        
        /* æ¼²è·Œé¡è‰²æ¨™ç¤º (å°è‚¡ç¿’æ…£ï¼šç´…æ¼²ç¶ è·Œ) */
        .up-red { color: #e74c3c; font-weight: bold; }
        .down-green { color: #2ecc71; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“Š PCBç”¢æ¥­ä¸Šå¸‚æ«ƒå…¬å¸ç‡Ÿæ”¶æŸ¥è©¢ç³»çµ±</h2>
    
    <div class="controls">
        <div>
            <label>1. é¸æ“‡å±¬æ€§ï¼š</label>
            <select id="categorySelect" onchange="onCategoryChange()">
                <option value="">è«‹é¸æ“‡...</option>
            </select>
        </div>
        <div>
            <label>2. é¸æ“‡å…¬å¸ï¼š</label>
            <select id="companySelect">
                <option value="">è«‹å…ˆé¸æ“‡å±¬æ€§</option>
            </select>
        </div>
        <button onclick="updateView()">æŸ¥è©¢ç‡Ÿæ”¶èµ°å‹¢</button>
    </div>

    <div id="loadingMsg" class="loading">æ­£åœ¨å¾è³‡æ–™åº«è¼‰å…¥èˆ‡é‹ç®— YoY/MoM è³‡æ–™ï¼Œè«‹ç¨å€™...</div>

    <div class="chart-container" id="chartWrapper" style="display:none;">
        <div id="revenueChart" style="width: 100%; height: 100%;"></div>
    </div>

    <div class="data-table-container" id="tableWrapper" style="display:none;">
        <table id="resultTable">
            <thead>
                <tr>
                    <th>å¹´æœˆ</th>
                    <th>å…¬å¸åç¨±</th>
                    <th>ç‡Ÿæ”¶ (åƒå…ƒ)</th>
                    <th>MoM (æœˆå¢ç‡)</th>
                    <th>YoY (å¹´å¢ç‡)</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/1m1IYE4kHPEmbamOlUIUjgPzRzzNMkqBLY60jH41kaoA/gviz/tq?tqx=out:csv&gid=1124990978';
    
    let longFormatData = []; 
    let categoryMap = {}; 
    let myChart = null;      

    function getPrevMonth(dateStr) {
        let [y, m] = dateStr.split('-');
        let d = new Date(y, m - 1 - 1, 1);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    function getPrevYear(dateStr) {
        let [y, m] = dateStr.split('-');
        return `${y - 1}-${m}`;
    }

    function parseMonthHeader(headerStr) {
        const match = headerStr.match(/(\d+)æœˆ-(\d+)/);
        if (!match) return null;
        let month = match[1].padStart(2, '0');
        let yearNum = parseInt(match[2], 10);
        let year = yearNum > 50 ? (1900 + yearNum) : (2000 + yearNum); 
        return `${year}-${month}`;
    }

    Papa.parse(sheetUrl, {
        download: true,
        header: true,
        complete: function(results) {
            const rawData = results.data;
            const headers = results.meta.fields;
            
            const companyColName = headers[0]; 
            const categoryColName = headers[1]; 

            rawData.forEach(row => {
                const companyName = row[companyColName];
                const categoryName = row[categoryColName] || 'æœªåˆ†é¡'; 
                
                if (!companyName || companyName.trim() === '') return; 

                if (!categoryMap[categoryName]) categoryMap[categoryName] = new Set();
                categoryMap[categoryName].add(companyName.trim());

                for(let i = 2; i < headers.length; i++) {
                    const header = headers[i];
                    const standardDate = parseMonthHeader(header);
                    
                    if (standardDate) {
                        let rawValue = row[header];
                        let revenueVal = 0;
                        if(rawValue) revenueVal = parseFloat(rawValue.replace(/,/g, ''));
                        
                        if (!isNaN(revenueVal) && rawValue !== "") {
                            longFormatData.push({
                                company: companyName.trim(),
                                category: categoryName,
                                date: standardDate,
                                revenue: revenueVal
                            });
                        }
                    }
                }
            });

            calculateGrowthRates(); 

            document.getElementById('loadingMsg').style.display = 'none';
            document.getElementById('chartWrapper').style.display = 'block';
            document.getElementById('tableWrapper').style.display = 'block';
            
            populateCategoryDropdown();
        },
        error: function() {
            document.getElementById('loadingMsg').innerText = 'è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªè©¦ç®—è¡¨æ¬Šé™ã€‚';
            document.getElementById('loadingMsg').style.color = 'red';
        }
    });

    function calculateGrowthRates() {
        let revDict = {};
        longFormatData.forEach(item => {
            if (!revDict[item.company]) revDict[item.company] = {};
            revDict[item.company][item.date] = item.revenue;
        });

        longFormatData.forEach(item => {
            let prevM = getPrevMonth(item.date);
            let prevY = getPrevYear(item.date);
            
            let revPrevM = revDict[item.company][prevM];
            let revPrevY = revDict[item.company][prevY];
            
            if (revPrevM && revPrevM !== 0) {
                item.mom = ((item.revenue - revPrevM) / revPrevM) * 100;
            } else {
                item.mom = null;
            }
            
            if (revPrevY && revPrevY !== 0) {
                item.yoy = ((item.revenue - revPrevY) / revPrevY) * 100;
            } else {
                item.yoy = null;
            }
        });
    }

    function populateCategoryDropdown() {
        const catSelect = document.getElementById('categorySelect');
        const categories = Object.keys(categoryMap).sort();
        
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.text = cat;
            catSelect.appendChild(option);
        });
    }

    function onCategoryChange() {
        const catSelect = document.getElementById('categorySelect');
        const compSelect = document.getElementById('companySelect');
        const selectedCat = catSelect.value;
        
        compSelect.innerHTML = ''; 
        
        if (!selectedCat) {
            compSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å±¬æ€§</option>';
            return;
        }

        // â­ æ–°å¢åŠŸèƒ½ï¼šå‹•æ…‹åŠ å…¥ã€Œæ•´é«”ç‡Ÿæ”¶ã€é¸é …
        const allOption = document.createElement('option');
        allOption.value = 'ALL_IN_CATEGORY';
        allOption.text = `â­ ${selectedCat} ç”¢æ¥­æ•´é«”ç‡Ÿæ”¶`;
        compSelect.appendChild(allOption);

        const companies = Array.from(categoryMap[selectedCat]).sort();
        companies.forEach(comp => {
            const option = document.createElement('option');
            option.value = comp;
            option.text = comp;
            compSelect.appendChild(option);
        });
    }

    function formatPercent(val) {
        if (val === null || val === undefined) return '-';
        let sign = val > 0 ? '+' : '';
        let colorClass = val > 0 ? 'up-red' : (val < 0 ? 'down-green' : '');
        return `<span class="${colorClass}">${sign}${val.toFixed(2)}%</span>`;
    }

    function formatPercentForTooltip(val) {
        if (val === null || val === undefined) return '-';
        let sign = val > 0 ? '+' : '';
        let color = val > 0 ? '#e74c3c' : (val < 0 ? '#2ecc71' : '#333');
        return `<span style="color:${color}; font-weight:bold;">${sign}${val.toFixed(2)}%</span>`;
    }

    function updateView() {
        const selectedCat = document.getElementById('categorySelect').value;
        const selectedCompany = document.getElementById('companySelect').value;
        
        if (!selectedCat || !selectedCompany) {
            alert('è«‹å®Œæ•´é¸æ“‡å±¬æ€§èˆ‡å…¬å¸åç¨±ï¼');
            return;
        }
        
        let filtered = [];
        let chartTitle = '';

        // â­ æ–°å¢åŠŸèƒ½ï¼šè‹¥é¸æ“‡ã€Œæ•´é«”ç‡Ÿæ”¶ã€ï¼Œå‰‡åœ¨èƒŒæ™¯å‹•æ…‹åŠ ç¸½è³‡æ–™
        if (selectedCompany === 'ALL_IN_CATEGORY') {
            chartTitle = `${selectedCat} ç”¢æ¥­æ•´é«”èµ°å‹¢`;
            let aggregated = {};
            
            // 1. å°‡è©²é¡åˆ¥ä¸‹æ‰€æœ‰å…¬å¸çš„æ¯å€‹æœˆç‡Ÿæ”¶åŠ ç¸½
            longFormatData.forEach(row => {
                if (row.category === selectedCat) {
                    if (!aggregated[row.date]) aggregated[row.date] = 0;
                    aggregated[row.date] += row.revenue;
                }
            });

            // 2. å°‡åŠ ç¸½å¾Œçš„ç‰©ä»¶è½‰å›é™£åˆ—ï¼Œä¸¦æ’åº
            filtered = Object.keys(aggregated).map(date => ({
                date: date,
                company: `æ•´é«” ${selectedCat}`,
                revenue: aggregated[date]
            }));
            filtered.sort((a, b) => a.date.localeCompare(b.date));

            // 3. é‡æ–°è¨ˆç®—æ•´é«”ç”¢æ¥­çš„ MoM èˆ‡ YoY
            filtered.forEach(item => {
                let prevM = getPrevMonth(item.date);
                let prevY = getPrevYear(item.date);
                
                let revPrevM = aggregated[prevM];
                let revPrevY = aggregated[prevY];
                
                item.mom = (revPrevM && revPrevM !== 0) ? ((item.revenue - revPrevM) / revPrevM) * 100 : null;
                item.yoy = (revPrevY && revPrevY !== 0) ? ((item.revenue - revPrevY) / revPrevY) * 100 : null;
            });
            
        } else {
            // åŸæœ¬çš„å–®ä¸€å…¬å¸æŸ¥è©¢é‚è¼¯
            chartTitle = selectedCompany;
            filtered = longFormatData.filter(row => row.company === selectedCompany);
            filtered.sort((a, b) => a.date.localeCompare(b.date));
        }

        updateTable(filtered);
        updateChart(filtered, chartTitle);
    }

    function updateTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
            return;
        }
        
        const reversedData = [...data].reverse();
        reversedData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.date}</td>
                <td>${row.company}</td>
                <td style="text-align: right;">${row.revenue.toLocaleString()}</td>
                <td>${formatPercent(row.mom)}</td>
                <td>${formatPercent(row.yoy)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // æ¥æ”¶ chartTitle ä½œç‚ºåƒæ•¸ï¼Œè®“åœ–è¡¨æ¨™é¡Œå‹•æ…‹æ”¹è®Š
    function updateChart(data, chartTitle) {
        const chartDom = document.getElementById('revenueChart');
        if (myChart) myChart.dispose();
        myChart = echarts.init(chartDom);

        const labels = data.map(item => item.date);
        const revenues = data.map(item => item.revenue);

        const option = {
            tooltip: {
                trigger: 'axis',
                formatter: function (params) {
                    let date = params[0].name;
                    let val = params[0].value;
                    let item = data.find(d => d.date === date);
                    
                    let momStr = formatPercentForTooltip(item.mom);
                    let yoyStr = formatPercentForTooltip(item.yoy);
                    
                    return `${date}<br/>ç‡Ÿæ”¶: <b>${val.toLocaleString()}</b> åƒå…ƒ<br/>æœˆå¢ (MoM): ${momStr}<br/>å¹´å¢ (YoY): ${yoyStr}`;
                },
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#ccc',
                textStyle: { color: '#333' }
            },
            grid: { left: '2%', right: '8%', bottom: '15%', containLabel: true },
            xAxis: {
                type: 'category',
                data: labels,
                boundaryGap: false,
                axisLine: { lineStyle: { color: '#aaa' } }
            },
            yAxis: {
                type: 'value',
                axisLabel: { formatter: function(value) { return value.toLocaleString(); } },
                splitLine: { lineStyle: { color: '#f5f5f5' } }
            },
            dataZoom: [
                { type: 'slider', show: true, xAxisIndex: [0], start: 80, end: 100, bottom: 10, right: '8%' },
                { type: 'inside', xAxisIndex: [0], start: 80, end: 100 }
            ],
            series: [{
                name: chartTitle, // ä½¿ç”¨å‹•æ…‹æ¨™é¡Œ
                type: 'line',
                data: revenues,
                itemStyle: { color: '#1971c2' }, 
                areaStyle: { color: 'rgba(25, 113, 194, 0.1)' },
                symbol: 'none', 
                smooth: true 
            }]
        };

        myChart.setOption(option);
        window.addEventListener('resize', function() { myChart.resize(); });
    }
</script>
</body>
</html>
