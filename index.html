<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCBÁî¢Ê•≠‰∏äÂ∏ÇÊ´ÉÁáüÊî∂ÂàÜÊûê</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        :root { 
            --primary: #1971c2; 
            --sub-sum-bg: #f1f3f5; 
            --pcb-total-bg: #e7f5ff; 
            --mat-total-bg: #f3f0ff; 
            --eq-total-bg: #fff9db;  
        }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; padding: 15px; background: #f4f7f9; color: #333; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
        
        header { display: flex; flex-direction: column; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .data-source { font-size: 0.8rem; color: #888; margin-top: 5px; }
        h2 { margin: 0; font-size: 1.5rem; color: var(--primary); }

        .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; background: #fafafa; padding: 10px 15px; border-radius: 6px; margin-bottom: 15px; font-size: 0.95rem; }
        .tab-group { display: flex; background: #eee; padding: 3px; border-radius: 6px; }
        .tab-btn { padding: 6px 15px; border: none; background: none; cursor: pointer; border-radius: 4px; font-size: 0.9rem; transition: 0.2s; }
        .tab-btn.active { background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: var(--primary); font-weight: bold; }

        select { padding: 5px 10px; border: 1px solid #ccc; border-radius: 4px; outline: none; background: #fff; cursor: pointer; }
        select:disabled { background: #f5f5f5; color: #aaa; cursor: not-allowed; }

        .table-area { overflow-x: auto; max-height: 600px; border: 1px solid #eee; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 1000px; }
        th { background: #f8f9fa; position: sticky; top: 0; z-index: 10; padding: 10px; border: 1px solid #eee; }
        td { padding: 8px 10px; border: 1px solid #eee; text-align: center; }
        
        .sum-row { background-color: var(--sub-sum-bg) !important; font-weight: bold; }
        .total-pcb { background-color: var(--pcb-total-bg) !important; font-weight: bold; border-top: 2px solid #339af0 !important; }
        .total-mat { background-color: var(--mat-total-bg) !important; font-weight: bold; border-top: 2px solid #845ef7 !important; }
        .total-eq { background-color: var(--eq-total-bg) !important; font-weight: bold; border-top: 2px solid #fcc419 !important; }

        .up { color: #e74c3c; font-weight: bold; }
        .down { color: #2ecc71; font-weight: bold; }
        .chart-box { height: 420px; margin-bottom: 20px; border: 1px solid #eee; padding: 5px; border-radius: 4px; background: #fff; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-top">
            <h2>üìä PCBÁî¢Ê•≠‰∏äÂ∏ÇÊ´ÉÁáüÊî∂ÂàÜÊûê</h2>
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchMode('trend')">Ê≠∑Âπ¥ÁáüÊî∂Ëµ∞Âã¢</button>
                <button class="tab-btn" onclick="switchMode('cross')">ÂñÆÊúàÂêåÊ•≠ÊØîËºÉ</button>
            </div>
        </div>
        <div class="data-source">Ë≥áÊñô‰æÜÊ∫êÔºöÂÖ¨ÈñãË≥áË®äËßÄÊ∏¨Á´ô (MOPS)</div>
    </header>

    <div class="controls">
        <span>Áî¢Ê•≠È°ûÂà•:</span>
        <select id="catSel" onchange="onCatChange()"></select>

        <div id="compBox">
            <span>ÂÖ¨Âè∏:</span>
            <select id="compSel" onchange="updateView()"></select>
        </div>

        <div id="dateBox" style="display:none; align-items: center; gap: 10px;">
            <span>Âπ¥‰ªΩ:</span>
            <select id="yearSel" onchange="validateMonths()"></select>
            <span>Êúà‰ªΩ:</span>
            <select id="monthSel" onchange="updateView()"></select>
        </div>
    </div>

    <div id="chartWrapper" class="chart-box">
        <div id="mainChart" style="width:100%; height:100%;"></div>
    </div>

    <div class="table-area">
        <table>
            <thead><tr id="tHead"></tr></thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>
</div>

<script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRv9UI5EshxGcMZgMwHt_1X7ZrGVJOyxcX--csAHwRg8zlb7wFOc0vKDA5KndHPfZzD_lOiDULOHqyI/pub?gid=1625717378&single=true&output=csv';
    
    let rawStore = []; 
    let compsByCat = { "PCB": {}, "ÂéüÁâ©Êñô": {}, "Ë®≠ÂÇô": {} }; 
    let availableDates = new Set(); 
    let chart = null;
    let mode = 'trend';

    const sortWeight = {
        "Á°¨Êùø": 1, "ËªüÊùø": 2,
        "ÁéªÁ∫ñ": 1, "ÈäÖÁÆî": 2, "CCL": 3, "FCCL": 4, "ÂéüÁâ©ÊñôÁõ∏Èóú": 5,
        "Ë®≠ÂÇô": 1
    };

    function parseD(s) {
        let m = String(s).match(/^(\d{4})[-\/](\d{1,2})/) || String(s).match(/^(\d{1,2})Êúà?-(\d{2,3})$/);
        if (!m) return null;
        let y = m[1].length === 4 ? m[1] : (parseInt(m[2]) >= 50 ? 1900 + parseInt(m[2]) : 2000 + parseInt(m[2]));
        let mon = (m[1].length === 4 ? m[2] : m[1]).padStart(2, '0');
        return { y: String(y), m: mon, full: `${y}-${mon}` };
    }

    Papa.parse(sheetUrl, {
        download: true,
        complete: function(res) {
            const d = res.data;
            if(!d || d.length < 5) return;
            const cRow = d[1], tRow = d[3];

            for (let c = 1; c < cRow.length; c++) {
                let name = String(cRow[c]).trim(), type = String(tRow[c]).trim();
                if (!name) continue;
                let cat = type.match(/Á°¨Êùø|ËªüÊùø/) ? "PCB" : (type.includes("Ë®≠ÂÇô") ? "Ë®≠ÂÇô" : "ÂéüÁâ©Êñô");
                compsByCat[cat][name] = type;
            }

            const catSel = document.getElementById('catSel');
            Object.keys(compsByCat).forEach(k => catSel.appendChild(new Option(k, k)));

            for (let r = 4; r < d.length; r++) {
                let t = parseD(d[r][0]);
                if (!t) continue;
                availableDates.add(t.full);
                for (let c = 1; c < cRow.length; c++) {
                    let name = String(cRow[c]).trim();
                    let val = parseFloat(String(d[r][c]).replace(/,/g, ''));
                    if (name && !isNaN(val)) rawStore.push({ name, date: t.full, y: t.y, m: t.m, rev: val, type: tRow[c] });
                }
            }
            
            const yearSel = document.getElementById('yearSel');
            const endYear = new Date().getFullYear();
            for(let y = endYear; y >= 1999; y--) yearSel.appendChild(new Option(y + "Âπ¥", y));
            
            let dateArr = Array.from(availableDates).sort().reverse();
            let latest = dateArr[0].split('-');
            yearSel.value = parseInt(latest[0]);
            
            calcRates();
            onCatChange();
            validateMonths(latest[1]);
            updateView();
        }
    });

    function calcRates() {
        let dict = {};
        rawStore.forEach(i => { if(!dict[i.name]) dict[i.name] = {}; dict[i.name][i.date] = i.rev; });
        rawStore.forEach(i => {
            let [y, m] = i.date.split('-');
            let pm = `${new Date(y, m-2, 1).getFullYear()}-${String(new Date(y, m-2, 1).getMonth()+1).padStart(2, '0')}`;
            let py = `${i.y - 1}-${i.m}`;
            i.mom = dict[i.name][pm] ? (i.rev - dict[i.name][pm])/dict[i.name][pm]*100 : null;
            i.yoy = dict[i.name][py] ? (i.rev - dict[i.name][py])/dict[i.name][py]*100 : null;
        });
    }

    function validateMonths(defaultMonth = null) {
        const year = document.getElementById('yearSel').value;
        const monthSel = document.getElementById('monthSel');
        const currentVal = monthSel.value;
        monthSel.innerHTML = '';
        let firstAvailable = null;
        for(let i = 1; i <= 12; i++) {
            let mStr = String(i).padStart(2, '0');
            let hasData = availableDates.has(`${year}-${mStr}`);
            let opt = new Option(i + "Êúà" + (hasData ? "" : " (ÁÑ°Ë≥áÊñô)"), mStr);
            if (!hasData) { opt.disabled = true; opt.style.color = "#ccc"; }
            else if (!firstAvailable) firstAvailable = mStr;
            monthSel.add(opt);
        }
        monthSel.value = (defaultMonth && availableDates.has(`${year}-${defaultMonth}`)) ? defaultMonth : 
                        (availableDates.has(`${year}-${currentVal}`) ? currentVal : (firstAvailable || "01"));
        updateView();
    }

    function switchMode(m) {
        mode = m;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText === (m === 'trend' ? 'Ê≠∑Âπ¥ÁáüÊî∂Ëµ∞Âã¢' : 'ÂñÆÊúàÂêåÊ•≠ÊØîËºÉ')));
        document.getElementById('compBox').style.display = m === 'trend' ? 'block' : 'none';
        document.getElementById('dateBox').style.display = m === 'cross' ? 'flex' : 'none';
        document.getElementById('chartWrapper').style.display = m === 'trend' ? 'block' : 'none';
        updateView();
    }

    function onCatChange() {
        const cat = document.getElementById('catSel').value;
        const sel = document.getElementById('compSel'); sel.innerHTML = '';
        if(!cat) return;
        sel.appendChild(new Option(`‚≠ê ${cat}Êï¥È´îË∂®Âã¢`, 'ALL'));
        Object.keys(compsByCat[cat]).sort().forEach(c => sel.appendChild(new Option(c, c)));
        updateView();
    }

    function updateView() {
        const cat = document.getElementById('catSel').value;
        if(!cat) return;
        if(mode === 'trend') renderTrend(cat, document.getElementById('compSel').value);
        else renderCross(cat, `${document.getElementById('yearSel').value}-${document.getElementById('monthSel').value}`);
    }

    function renderTrend(cat, comp) {
        let d = [];
        if(comp === 'ALL') {
            let agg = {};
            rawStore.forEach(r => { if(compsByCat[cat][r.name]) agg[r.date] = (agg[r.date]||0) + r.rev; });
            d = Object.keys(agg).sort().map(date => ({ date, rev: agg[date] }));
            d.forEach(i => {
                let [y,m] = i.date.split('-');
                let pm = `${new Date(y, m-2, 1).getFullYear()}-${String(new Date(y, m-2, 1).getMonth()+1).padStart(2, '0')}`;
                let py = `${y-1}-${m}`;
                i.mom = agg[pm] ? (i.rev - agg[pm])/agg[pm]*100 : null;
                i.yoy = agg[py] ? (i.rev - agg[py])/agg[py]*100 : null;
            });
        } else {
            d = rawStore.filter(r => r.name === comp).sort((a,b) => a.date.localeCompare(b.date));
        }
        fillTable(['Âπ¥Êúà', 'ÁáüÊî∂(ÂçÉÂÖÉ)', 'MoM', 'YoY'], d.slice().reverse(), r => `<td>${r.date}</td><td style="text-align:right">${Math.round(r.rev).toLocaleString()}</td><td>${fPct(r.mom)}</td><td>${fPct(r.yoy)}</td>`);
        draw(comp==='ALL'?cat+'Êï¥È´îË∂®Âã¢':comp, d.map(i=>i.date), d.map(i=>i.rev));
    }

    // üåü Ê†∏ÂøÉÂçáÁ¥öÔºöË®àÁÆóÁ¥ØÁ©çÁáüÊî∂ËàáÁ¥ØÊî∂ YoY
    function renderCross(cat, targetDate) {
        let [y, m] = targetDate.split('-');
        let targetMonthInt = parseInt(m);
        
        let items = rawStore.filter(r => r.date === targetDate && compsByCat[cat][r.name]);
        
        // ÊéíÂ∫èÂª†ÂïÜ
        items.sort((a, b) => {
            let wA = sortWeight[a.type] || 99, wB = sortWeight[b.type] || 99;
            if (wA !== wB) return wA - wB;
            return b.rev - a.rev;
        });

        // Âª∫Á´ãÁ¥ØÁ©çÊï∏ÊìöÂ≠óÂÖ∏
        let accData = {}; // {ÂÖ¨Âè∏: {accRev:0, lastAccRev:0}}
        rawStore.forEach(r => {
            if (compsByCat[cat][r.name]) {
                if (!accData[r.name]) accData[r.name] = { acc: 0, lastAcc: 0 };
                let rY = parseInt(r.y), rM = parseInt(r.m);
                if (rY === parseInt(y) && rM <= targetMonthInt) accData[r.name].acc += r.rev;
                if (rY === parseInt(y)-1 && rM <= targetMonthInt) accData[r.name].lastAcc += r.rev;
            }
        });

        // Ë®àÁÆóÈ°ûÂà•Á∏ΩÂíå (ÂåÖÂê´Á¥ØÁ©ç)
        let subSums = {}; 
        let majorSum = { rev:0, prevM:0, prevY:0, acc:0, lastAcc:0 };

        rawStore.forEach(r => {
            if (compsByCat[cat][r.name]) {
                let t = r.type;
                if(!subSums[t]) subSums[t] = { rev:0, prevM:0, prevY:0, acc:0, lastAcc:0 };
                let rDate = r.date, rY = parseInt(r.y), rM = parseInt(r.m);
                
                if (rDate === targetDate) { subSums[t].rev += r.rev; majorSum.rev += r.rev; }
                if (rDate === `${new Date(y, m-2, 1).getFullYear()}-${String(new Date(y, m-2, 1).getMonth()+1).padStart(2, '0')}`) { subSums[t].prevM += r.rev; majorSum.prevM += r.rev; }
                if (rDate === `${parseInt(y)-1}-${m}`) { subSums[t].prevY += r.rev; majorSum.prevY += r.rev; }
                
                if (rY === parseInt(y) && rM <= targetMonthInt) { subSums[t].acc += r.rev; majorSum.acc += r.rev; }
                if (rY === parseInt(y)-1 && rM <= targetMonthInt) { subSums[t].lastAcc += r.rev; majorSum.lastAcc += r.rev; }
            }
        });

        const rows = [];
        items.forEach((i, idx) => {
            let acc = accData[i.name].acc;
            let lastAcc = accData[i.name].lastAcc;
            let accYoy = lastAcc ? (acc - lastAcc) / lastAcc * 100 : null;
            rows.push({ ...i, idx: idx+1, acc, accYoy, cls: '' });
        });

        // ÊèíÂÖ•Á¥∞È°ûÁµ±Ë®à
        Object.keys(subSums).sort((a,b) => (sortWeight[a]||99)-(sortWeight[b]||99)).forEach(t => {
            if (t === 'Ë®≠ÂÇô' && cat === 'Ë®≠ÂÇô') return;
            let mom = subSums[t].prevM ? (subSums[t].rev - subSums[t].prevM)/subSums[t].prevM*100 : null;
            let yoy = subSums[t].prevY ? (subSums[t].rev - subSums[t].prevY)/subSums[t].prevY*100 : null;
            let accYoy = subSums[t].lastAcc ? (subSums[t].acc - subSums[t].lastAcc)/subSums[t].lastAcc*100 : null;
            rows.push({ name: t+'Á∏ΩÂíå', type:'', rev: subSums[t].rev, mom, yoy, acc: subSums[t].acc, accYoy, idx: '', cls: 'sum-row' });
        });

        // Â§ßÈ°ûÁ∏ΩÂíå
        let mMom = majorSum.prevM ? (majorSum.rev - majorSum.prevM)/majorSum.prevM*100 : null;
        let mYoy = majorSum.prevY ? (majorSum.rev - majorSum.prevY)/majorSum.prevY*100 : null;
        let mAccYoy = majorSum.lastAcc ? (majorSum.acc - majorSum.lastAcc)/majorSum.lastAcc*100 : null;
        rows.push({ name: cat+'Á∏ΩÂíå', type:'', rev: majorSum.rev, mom: mMom, yoy: mYoy, acc: majorSum.acc, accYoy: mAccYoy, idx: '', cls: cat==='PCB'?'total-pcb':(cat==='ÂéüÁâ©Êñô'?'total-mat':'total-eq') });

        fillTable(['Â∫è', 'ÂÖ¨Âè∏ÂêçÁ®±', 'È°ûÂûã', 'ÁáüÊî∂(ÂçÉÂÖÉ)', 'MoM', 'YoY', 'Á¥ØÁ©çÁáüÊî∂', 'Á¥ØÊî∂YoY'], rows, r => `
            <td class="${r.cls}">${r.idx}</td>
            <td class="${r.cls}">${r.name}</td>
            <td class="${r.cls}">${r.type || ''}</td>
            <td class="${r.cls}" style="text-align:right">${Math.round(r.rev).toLocaleString()}</td>
            <td class="${r.cls}">${fPct(r.mom)}</td>
            <td class="${r.cls}">${fPct(r.yoy)}</td>
            <td class="${r.cls}" style="text-align:right">${Math.round(r.acc).toLocaleString()}</td>
            <td class="${r.cls}">${fPct(r.accYoy)}</td>
        `);
    }

    function fillTable(h, d, fn) {
        document.getElementById('tHead').innerHTML = h.map(i => `<th>${i}</th>`).join('');
        document.getElementById('tBody').innerHTML = d.map(r => `<tr>${fn(r)}</tr>`).join('');
    }

    function fPct(v) { return v === null ? '-' : `<span class="${v>0?'up':'down'}">${v>0?'+':''}${v.toFixed(2)}%</span>`; }

    function draw(t, x, s) {
        if(chart) chart.dispose();
        chart = echarts.init(document.getElementById('mainChart'));
        chart.setOption({
            title: { text: t, left: 'center', top: 5 },
            tooltip: { trigger: 'axis' },
            grid: { top: 50, bottom: 85, left: 85, right: 85, containLabel: true },
            xAxis: { type: 'category', data: x, axisLabel: { rotate: 45, interval: 'auto', margin: 15, fontSize: 11, align: 'right', hideOverlap: true } },
            yAxis: { type: 'value', axisLabel: { formatter: v => (v/1000000).toFixed(1) + 'B', fontSize: 11 } },
            dataZoom: [{ type: 'slider', bottom: 8, height: 18, handleSize: '100%', start: x.length > 24 ? 100-(24/x.length*100) : 0 }],
            series: [{ data: s, type: 'line', smooth: true, areaStyle: { color: 'rgba(25, 113, 194, 0.08)' }, itemStyle: { color: '#1971c2' } }]
        });
        window.addEventListener('resize', () => chart.resize());
    }
</script>
</body>
</html>
